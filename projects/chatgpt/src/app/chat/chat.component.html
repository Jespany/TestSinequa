
<ng-container *ngIf="loading" [ngTemplateOutlet]="loadingTpl">
</ng-container>

<ul *ngIf="messages$ | async as messages" class="list-group py-2 shadow-lg">

  <ng-container *ngFor="let message of messages; let i = index">
    <ng-container *ngTemplateOutlet="messageTpl; context: {$implicit: message}"></ng-container>
  </ng-container>

  <div class="progress flex-shrink-0" *ngIf="!loadingAnswer">
    <div class="progress-bar" role="progressbar" [ngStyle]="{'width.%': tokensPercentage}" title="Tokens used {{tokensAbsolute}}/{{tokens?.model - config.modelMaxTokens}}"></div>
  </div>

  <ng-container *ngIf="!loadingAnswer">
    <ng-container *ngIf="config.textBeforeAttachments">
      <ng-container *ngTemplateOutlet="inputTpl"></ng-container>
      <ng-container *ngTemplateOutlet="attachmentListTpl"></ng-container>
    </ng-container>

    <ng-container *ngIf="!config.textBeforeAttachments">
      <ng-container *ngTemplateOutlet="attachmentListTpl"></ng-container>
      <ng-container *ngTemplateOutlet="inputTpl"></ng-container>
    </ng-container>
  </ng-container>

  <ng-container *ngIf="loadingAnswer">
    <ng-container *ngTemplateOutlet="messageTpl; context: { $implicit: {
      role: 'user', content: question, display: true, $attachments: (chatService.attachments$ | async)
    } }">
    </ng-container>

    <li class="list-group-item">
      <ng-container *ngTemplateOutlet="loadingTpl"></ng-container>
    </li>
  </ng-container>
</ul>


<!-- NG TEMPLATES-->

<ng-template #loadingTpl>
  <div class="spinner-grow text-success d-block mx-auto my-5" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</ng-template>

<ng-template #messageTpl let-message>
  <li class="list-group-item" *ngIf="message.$attachments?.length && !config.textBeforeAttachments">
    <ng-container *ngTemplateOutlet="attachmentTpl; context:{$implicit: message.$attachments}"></ng-container>
  </li>
  <li class="list-group-item" *ngIf="message.display" [ngClass]="{'border-bottom': !message.$attachments || !config.textBeforeAttachments}">
    <div class="d-flex">
      <span class="me-3" [title]="message.role" [ngSwitch]="message.role">
        <i class="fas fa-2x fa-user-circle text-muted" *ngSwitchCase="'user'"></i>
        <i class="sq-chatgpt" [style.--sq-size.px]="28" *ngSwitchCase="'assistant'"></i>
      </span>
      <div [innerHTML]="message.content | sqMarkdown"></div>
    </div>
  </li>
  <li class="list-group-item border-bottom" *ngIf="message.$attachments?.length && config.textBeforeAttachments">
    <ng-container *ngTemplateOutlet="attachmentTpl; context:{$implicit: message.$attachments}"></ng-container>
  </li>
</ng-template>

<ng-template #inputTpl>
  <li class="list-group-item">
    <div class="d-flex align-items-center">
      <span class="me-3">
        <i class="fas fa-2x fa-user-circle text-muted"></i>
      </span>
      <input #questionInput
        type="search" class="form-control rounded-5 px-3"
        placeholder="Your answer" autofocus
        [(ngModel)]="question"
        (ngModelChange)="updateTokensPercentage()"
        (keyup.enter)="submitQuestion()"
        (keyup.shift.enter)="submitQuestion()"
        [disabled]="tokensPercentage >= 100">
    </div>
  </li>
</ng-template>

<ng-template #attachmentTpl let-attachments>
  <div class="d-flex" *ngIf="attachments">
    <span class="px-2 me-3" title="Attachments">
      <i class="fas fa-paperclip text-muted"></i>
    </span>
    <span *ngIf="attachments.length as n" [title]="attachments[0].content">{{n}} {{n>1? 'attachments' : 'attachment'}}</span>
    <span *ngIf="!attachments.length">
      <i class="text-muted">Attach a document, snippet or extracts from the Sinequa results</i>
    </span>
  </div>
</ng-template>

<ng-template #attachmentListTpl>
  <ng-container *ngIf="chatService.attachments$ | async as attachments">
    <li class="list-group-item" *ngIf="attachments.length === 0">
      <ng-container *ngTemplateOutlet="attachmentTpl; context:{$implicit:[]}"></ng-container>
    </li>

    <li *ngFor="let attachment of attachments"
      class="attachment list-group-item d-flex"
      [ngClass]="{expanded: attachment.$expanded}">
      <span class="px-2 me-3" title="Attachments">
        <i class="fas fa-paperclip text-muted"></i>
      </span>
      <p class="flex-grow-1 mb-0" role="button" (click)="attachment.$expanded = !attachment.$expanded">
        <span>
          <i class="fas fa-fw fa-caret-{{attachment.$expanded? 'down' : 'right'}} pe-1"></i>
          <b>{{attachment.record.title}}: </b>
          <span>{{attachment.text}}</span>
        </span>
      </p>
      <div class="ms-3 col-1 small text-muted d-flex flex-column align-items-center">
        <span title="Number of tokens">{{attachment.tokenCount}}</span>
        <span>
          <button class="btn btn-sm btn-link px-1 py-0" sqTooltip="Fewer tokens" (click)="chatService.lessTokens(attachment)"><i class="fas fa-minus"></i></button>
          <button class="btn btn-sm btn-link px-1 py-0" sqTooltip="More tokens" (click)="chatService.moreTokens(attachment)"><i class="fas fa-plus"></i></button>
        </span>
        <button class="btn btn-sm btn-link py-0" sqTooltip="Remove" (click)="chatService.removeAttachment(attachment)"><i class="fas fa-trash"></i></button>
      </div>
    </li>
  </ng-container>
</ng-template>
