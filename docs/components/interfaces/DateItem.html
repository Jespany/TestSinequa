<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Components</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Components</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>DateItem</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>results-view/results-timeline-view/results-timeline-view.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#count">count</a>
                                </li>
                                <li>
                                        <a href="#date">date</a>
                                </li>
                                <li>
                                        <a href="#display">display</a>
                                </li>
                                <li>
                                        <a href="#value">value</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="count"></a>
                                        <span class="name"><b>count</b><a href="#count"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>count:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="date"></a>
                                        <span class="name"><b>date</b><a href="#date"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>date:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" >Date</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" >Date</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="display"></a>
                                        <span class="name"><b>display</b><a href="#display"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>display:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="value"></a>
                                        <span class="name"><b>value</b><a href="#value"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>value:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {
    Component, ViewEncapsulation, Input, OnChanges, SimpleChanges, ChangeDetectorRef, ElementRef, ViewChild, OnDestroy
} from &quot;@angular/core&quot;;
import {Utils} from &quot;@sinequa/core/base&quot;;
import {Query, AppService} from &quot;@sinequa/core/app-utils&quot;;
import {Results} from &quot;@sinequa/core/web-services&quot;;
import {LoadedComponent, LoadComponentService} from &quot;@sinequa/core/load-component&quot;;
import {ResultsView, ResultsViewService} from &quot;../results-view.service&quot;;
import {SearchService} from &quot;@sinequa/components/search&quot;;

import * as d3 from &quot;d3&quot;;
import {BsTimelineTooltip} from &quot;../results-timeline-tooltip/results-timeline-tooltip&quot;;

export interface DateItem {
    date: Date;
    count: number;
    value: string;
    display: string;
}

export interface EventItem {
    date: Date;
    count: number;
    value: string;
    display: string;
    event: string;
}

export interface TimelineView extends ResultsView {
    timelinename: string;
    aggregation: string;
    aggregationEvent: string;
    selectView?: string;
    n_dates?: string;
    n_events?: string;
    datemin?: string;
    datemax?: string;
}

@Component({
    selector: &quot;sq-results-timeline-view&quot;,
    encapsulation: ViewEncapsulation.None,
    templateUrl: &quot;./results-timeline-view.html&quot;,
    styleUrls: [&quot;./results-timeline-view.css&quot;]
})
export class BsResultsTimelineView implements OnChanges, OnDestroy {
    @Input() query: Query;
    @Input() results: Results;
    @Input() view: TimelineView;

    N_DATES &#x3D; 5;
    N_EVENTS &#x3D; 10;

    // Data
    datemin &#x3D; new Date(&quot;2010-01-01&quot;);
    datemax &#x3D; new Date(&quot;2020-01-01&quot;);
    dates: DateItem[] | undefined;
    events: EventItem[];
    datefield: string;
    eventfield: string;

    // Flags
    data_flags; // List of dates / events to be drawn
    flag_idx;   // Map of event type &#x3D;&gt; array of all events of this type
    selectedFlags;  // Array of currently selected event types
    event_page &#x3D; 0; // Pagination param
    n_flags;        // Number of event flags displayed

    // Elements
    @ViewChild(&quot;svg&quot;, {static: false}) svg: ElementRef;
    g: d3.Selection&lt;any, any, any, any&gt; | undefined;
    tooltip: LoadedComponent;

    // D3
    x: any;
    xAxis: any;
    y: any;
    colorscale : any;
    formatDayRequest &#x3D; d3.timeFormat(&quot;%Y-%m-%d&quot;);
    formatDay &#x3D; d3.timeFormat(&quot;%d %B %Y&quot;);
    formatMonth &#x3D; d3.timeFormat(&quot;%B %Y&quot;);

    redrawing : boolean;
    nmonths : number;

    constructor(
        public appService: AppService,
        public searchService: SearchService,
        public loadComponentService: LoadComponentService,
        public changeDetectorRef: ChangeDetectorRef,
        public resultsViewService: ResultsViewService) {
    }

    getData() {

        if (this.view.datemin) {
            const datemin &#x3D; new Date(this.view.datemin);
            if (!isNaN(datemin.getTime())) {
                this.datemin &#x3D; datemin;
            }
        }

        if (this.view.datemax) {
            const datemax &#x3D; new Date(this.view.datemax);
            if (!isNaN(datemax.getTime())) {
                this.datemax &#x3D; datemax;
            }
        }

        if (this.view.n_dates &amp;&amp; !isNaN(parseInt(this.view.n_dates, 10))) {
            this.N_DATES &#x3D; parseInt(this.view.n_dates, 10);
        }
        if (this.view.n_events &amp;&amp; !isNaN(parseInt(this.view.n_events, 10))) {
            this.N_EVENTS &#x3D; parseInt(this.view.n_events, 10);
        }

        const ccaggregation &#x3D; this.appService.getCCAggregation(this.view.aggregation);
        //console.log(ccaggregation);
        if (!ccaggregation) {
            this.dates &#x3D; undefined;
            return;
        }
        const query &#x3D; Query.copy(this.searchService.query);
        query.action &#x3D; &quot;aggregate&quot;;
        query.aggregations &#x3D; [this.view.aggregation];   // Override distribs with only the timeline
        this.datefield &#x3D; ccaggregation.column;

        const ccaggregationevent &#x3D; this.appService.getCCAggregation(this.view.aggregationEvent);
        if(ccaggregationevent){
            query.aggregations.push(this.view.aggregationEvent);
            this.eventfield &#x3D; ccaggregationevent.column;
        }

        Utils.subscribe(this.searchService.getResults(query),
            (results: Results) &#x3D;&gt; {
                this.dates &#x3D; results.aggregations[0].items
                    .filter((item) &#x3D;&gt; item.value &amp;&amp; item.value &gt; this.datemin &amp;&amp; item.value &lt;  this.datemax )
                    .map((item) &#x3D;&gt; {
                        return {
                            &quot;date&quot; : item.value as Date,
                            &quot;count&quot; : item.count,
                            &quot;value&quot; : this.formatDayRequest(item.value as Date),
                            &quot;display&quot; : this.formatDay(item.value as Date)
                        };
                    });

                if(results.aggregations.length &gt; 1 &amp;&amp; !!results.aggregations[1].items){
                    //console.log(results.aggregations[1].items);
                    results.aggregations[1].items
                        .forEach((item) &#x3D;&gt; {
                            const cooc &#x3D; item.display as string;
                            const coocs &#x3D; cooc.substr(1,cooc.length-2).split(&quot;)#(&quot;);
                            item[&quot;event&quot;] &#x3D; coocs[0];
                            item[&quot;date&quot;] &#x3D; new Date(coocs[1]);
                        });
                    this.events &#x3D; results.aggregations[1].items
                        .filter((item) &#x3D;&gt; item[&quot;date&quot;] &amp;&amp; item[&quot;date&quot;] &gt; this.datemin &amp;&amp; item[&quot;date&quot;] &lt; this.datemax)
                        .map((item) &#x3D;&gt; {
                            return {
                                &quot;date&quot; : item[&quot;date&quot;],
                                &quot;count&quot; : item.count,
                                &quot;event&quot; : item[&quot;event&quot;],
                                &quot;display&quot; : item[&quot;event&quot;] + &quot; (&quot; + this.formatDay(item[&quot;date&quot;])+&quot;)&quot;,
                                &quot;value&quot; : item[&quot;value&quot;] as string
                            };
                        });
                    this.flag_idx &#x3D; {};
                    this.selectedFlags &#x3D;[];
                    this.events.forEach((item) &#x3D;&gt; {
                        if(!(item[&quot;event&quot;] in this.flag_idx)){
                            this.flag_idx[item[&quot;event&quot;]] &#x3D; [];
                            this.selectedFlags.push(item[&quot;event&quot;]);
                        }
                        this.flag_idx[item[&quot;event&quot;]].push(item);
                    });
                    this.changeDetectorRef.detectChanges(); // This is needed so that the templates correctly updates with data
                }

                this.plotData();
            });
    }

    plotData() {
        this.clearPlot();
        if (!this.dates || this.dates.length &#x3D;&#x3D;&#x3D; 0) {
            return;
        }
        this.drawTimeline();
    }

    clearPlot() {
        if (this.g) {
            this.g.remove();
            this.g &#x3D; undefined;
        }
    }

    drawTimeline(){

        // Initial flags: top-5 dates + top-10 events
        if (!this.dates) {
            return;
        }
        this.data_flags &#x3D; this.dates.slice(0,this.N_DATES);
        if(this.events)
            this.data_flags &#x3D; this.data_flags.concat(this.events.slice(0,this.N_EVENTS));

        // Aggregates dates by months and weeks
        const data_hist &#x3D; this.histo_data(this.dates, &quot;months&quot;);
        const data_hist_weeks &#x3D; this.histo_data(this.dates, &quot;weeks&quot;);

        // console.log(data_hist);

        const margin &#x3D; {top: 10, right: 20, bottom: 20, left: 20},
            width &#x3D; 960 - margin.left - margin.right,
            height &#x3D; 550 - margin.top - margin.bottom;

        this.colorscale &#x3D; d3.scaleLinear&lt;d3.RGBColor,number&gt;()
            .domain([1,12])
            .range([d3.rgb(&#x27;#225ea8&#x27;), d3.rgb(&#x27;#7fcdbb&#x27;)]);

        //console.log(data_hist.length)
        // the x-scale parameters
        this.x &#x3D; d3.scaleTime&lt;number,Date&gt;()
            /*tslint:disable-next-line*/
            .domain([data_hist[0].x0!, data_hist[data_hist.length-1].x1!])
            .range([0, width]);

        const domain &#x3D; this.x.domain();
        this.nmonths &#x3D; d3.timeMonths(domain[0],domain[1]).length;

        // the y-scale parameters
        this.y &#x3D; d3.scaleLinear()
            .domain([0, d3.max(data_hist, function(d){ return d[&quot;y&quot;];})])
            .range([height, 0]);

        this.xAxis &#x3D; d3.axisBottom(this.x);
            //.tickFormat(formatMonth);

        /*var line_ &#x3D; d3.line()
            .x(function(this: any, d) { return this.x(d[0]); })
            .y(function(this: any, d) { return this.y(d[1]); });*/

        const brush &#x3D; d3.brushX()
            .extent([[this.x.range()[0], 0], [this.x.range()[1], height]])
            .on(&#x27;end&#x27;, () &#x3D;&gt; this.brushed(brush));

        const zoom_ &#x3D; d3.zoom&lt;SVGGElement, unknown&gt;()
            .on(&quot;zoom&quot;, () &#x3D;&gt; this.redraw());

        // Define the div for the tooltip
        //var div &#x3D; d3.select(&quot;body&quot;).append(&quot;div&quot;)
        //    .attr(&quot;class&quot;, &quot;tooltip&quot;)
        //    .style(&quot;opacity&quot;, 0);

        const svg &#x3D; d3.select(this.svg.nativeElement)
            .attr(&quot;width&quot;, width + margin.left + margin.right)
            .attr(&quot;height&quot;, height + margin.top + margin.bottom);

        this.g &#x3D; svg.append(&quot;g&quot;)
            .attr(&quot;transform&quot;, &#x60;translate(${margin.left},${margin.top})&#x60;);

        this.g.append(&quot;defs&quot;).append(&quot;clipPath&quot;)
            .attr(&quot;id&quot;, &quot;clip&quot;)
            .append(&quot;rect&quot;)
            .attr(&quot;width&quot;, width)
            .attr(&quot;height&quot;, height);

        this.g.append(&#x27;g&#x27;)
            .attr(&#x27;class&#x27;, &#x27;x brush&#x27;)
            .call(brush)
            .call(zoom_)
            .on(&quot;mousedown.zoom&quot;, null) // Deactivate mouse event (taken by brush)
            .on(&quot;touchstart.zoom&quot;, null)
            .on(&quot;touchmove.zoom&quot;, null)
            .on(&quot;touchend.zoom&quot;, null)
        .selectAll(&#x27;rect&#x27;)
            .attr(&#x27;y&#x27;, 0)
            .attr(&#x27;height&#x27;, height);

        const bars &#x3D; this.g.selectAll(&quot;.bar&quot;)
            .data(data_hist.concat(data_hist_weeks))
            .enter().append(&quot;rect&quot;);

        this.draw_bars(bars, height, this.nmonths);
        this.add_tooltips(bars);

        this.draw_flags();

        // draw the axes
        this.g.append(&quot;g&quot;)
            .attr(&quot;class&quot;, &quot;x axis&quot;)
            .attr(&quot;transform&quot;, &quot;translate(0,&quot; + height + &quot;)&quot;)
            .call(this.xAxis);

        /*svg.append(&quot;g&quot;)
            .attr(&quot;class&quot;, &quot;y axis&quot;)
            .call(yAxis);
        */
    }

    histo_data(data : DateItem[], scale : string){

        const date_extent &#x3D; d3.extent(data, function(d){return d.date;});

        let numHistBins : Date[];

        if(scale &#x3D;&#x3D;&#x3D; &quot;months&quot;)
            numHistBins &#x3D; d3.timeMonths(d3.timeMonth.offset(date_extent[0]!,-1), d3.timeMonth.offset(date_extent[1]!,1));
        else
            numHistBins &#x3D; d3.timeWeeks(d3.timeWeek.offset(date_extent[0]!,-1), d3.timeMonth.offset(date_extent[1]!,1));

        // the histogram function
        const histo &#x3D; d3.histogram&lt;DateItem,Date&gt;()
            .value(function(d){ return d.date; })
            .thresholds(numHistBins);

        const data_hist &#x3D; histo(data);

        //console.log(data_hist);

        data_hist.forEach(function(d){
            d[&quot;y&quot;] &#x3D; d.reduce(function(acc,val){return acc + val.count;}, 0);
            d[&quot;scale&quot;] &#x3D; scale;
        });

        return data_hist;
    }

    draw_bars(bars, height, nmonths){

        bars
            .attr(&quot;class&quot;, &quot;bar&quot;)
            .attr(&quot;x&quot;, (d) &#x3D;&gt; this.x(d.x0) + 1)
            .attr(&quot;width&quot;, (d) &#x3D;&gt; this.x(d.x1) - this.x(d.x0))
            .attr(&quot;y&quot;, (d) &#x3D;&gt; this.y(d.y))
            .attr(&quot;height&quot;, (d) &#x3D;&gt; height - this.y(d.y))
            .attr(&quot;clip-path&quot;, &quot;url(#clip)&quot;)
            .style(&quot;cursor&quot;, &quot;pointer&quot;)
            .style(&quot;fill&quot;, (d) &#x3D;&gt; this.colorscale(d.x0.getMonth()))
            .style(&quot;opacity&quot;, (d) &#x3D;&gt; (d.scale &#x3D;&#x3D;&#x3D; &quot;months&quot; &amp;&amp; nmonths &gt; 32) || (d.scale &#x3D;&#x3D;&#x3D; &quot;weeks&quot; &amp;&amp; nmonths &lt;&#x3D; 32) ? 1 : 0)
            ;

    }

    add_tooltips(bars){

        const tooltip &#x3D; d3.select(this.tooltip.componentRef.location.nativeElement);
        const instance &#x3D; this;

        bars
            .on(&quot;mouseover&quot;, function(this: any, d) {
                if(instance.redrawing) return;
                if(! ((d.scale &#x3D;&#x3D;&#x3D; &quot;months&quot; &amp;&amp; instance.nmonths &gt; 32) || (d.scale &#x3D;&#x3D;&#x3D; &quot;weeks&quot; &amp;&amp; instance.nmonths &lt;&#x3D; 32))) return;
                d3.select(this)
                    //.transition(&quot;t1&quot;)
                    //.duration(200)
                    .style(&quot;fill&quot;, &quot;#d00&quot;);
                tooltip //.transition(&quot;t2&quot;)
                    //.duration(200)
                    .style(&quot;opacity&quot;, .9);
                tooltip
                    .style(&quot;left&quot;, (d3.event.pageX) + &quot;px&quot;)
                    .style(&quot;top&quot;, (d3.event.pageY - 28) + &quot;px&quot;);
                instance.setTooltip(instance.formatMonth(d.x0), d);
                })
            .on(&quot;mouseout&quot;, function(this: any, d) {
                if(instance.redrawing) return;
                if(! ((d.scale &#x3D;&#x3D;&#x3D; &quot;months&quot; &amp;&amp; instance.nmonths &gt; 32) || (d.scale &#x3D;&#x3D;&#x3D; &quot;weeks&quot; &amp;&amp; instance.nmonths &lt;&#x3D; 32))) return;
                tooltip	//.transition(&quot;t3&quot;)
                    //.duration(200)
                    .style(&quot;opacity&quot;, 0);
                d3.select(this)
                    //.transition(&quot;t4&quot;)
                    //.duration(200)
                    .style(&quot;fill&quot;, (d : any) &#x3D;&gt; instance.colorscale(d.x0.getMonth()));
            })
            .on(&quot;click&quot;, (d) &#x3D;&gt; {
                if(! ((d.scale &#x3D;&#x3D;&#x3D; &quot;months&quot; &amp;&amp; this.nmonths &gt; 32) || (d.scale &#x3D;&#x3D;&#x3D; &quot;weeks&quot; &amp;&amp; this.nmonths &lt;&#x3D; 32))) return;
                const month_start &#x3D; this.formatDayRequest(d.x0);
                const month_end &#x3D; this.formatDayRequest(d.x1);
                this.filter(month_start, month_end);
            });
    }

    setTooltip(month, dates) {
        this.loadComponentService.bindComponent({component: BsTimelineTooltip, inputs: {month: month, dates: dates}}, this.tooltip);
    }

    draw_flags() {
        console.log(this.data_flags);
        if (!this.g) {
            return;
        }

        this.g.selectAll(&quot;.flag&quot;).remove();

        const flags &#x3D; this.g.selectAll(&quot;.flag&quot;)
            .data(this.data_flags)
            .enter()
            .append(&quot;g&quot;).attr(&quot;class&quot;, &quot;flag&quot;);

        flags.append(&quot;line&quot;)
            .attr(&quot;x1&quot;, (d : any) &#x3D;&gt; this.x(d.date))
            .attr(&quot;y1&quot;, (d : any) &#x3D;&gt; this.y(0))
            .attr(&quot;x2&quot;, (d : any) &#x3D;&gt; this.x(d.date))
            .attr(&quot;y2&quot;, (d : any,i) &#x3D;&gt; this.y_flag(i, this.data_flags.length))
            .attr(&quot;stroke-width&quot;, 2)
            .attr(&quot;stroke&quot;, &quot;#888&quot;);
        flags.append(&quot;rect&quot;);   // placeholder for background rect, position and size will be defined later
        flags.append(&quot;text&quot;) // content of text will be defined later
            .attr(&quot;x&quot;, (d : any) &#x3D;&gt; this.x(d.date)+10)
            .attr(&quot;y&quot;, (d : any,i) &#x3D;&gt; {
                d.index &#x3D; i;
                return this.y_flag(i, this.data_flags.length); })
            .attr(&quot;fill&quot;, &quot;#000&quot;)
            .style(&quot;font-size&quot;, &quot;10px&quot;)
            .attr(&quot;text-anchor&quot;, &quot;left&quot;)
            .style(&quot;cursor&quot;, &quot;pointer&quot;)
            .text((d : any) &#x3D;&gt;  d.display)
            .on(&quot;click&quot;, (d : any) &#x3D;&gt; {
                if(d.event)
                    this.filter_cooc(d.value, d.value);
                else
                    this.filter_date(d.value, d.display);
            })
            .each(function(d : any) {
                d.bb &#x3D; this.getBBox(); // get bounding box of text field and store it in texts array
            });

        flags.selectAll(&quot;rect&quot;)
            .attr(&quot;x&quot;, (d : any) &#x3D;&gt; this.x(d.date))
            .attr(&quot;y&quot;, (d : any) &#x3D;&gt; this.y_flag(d.index, this.data_flags.length) - d.bb.height)
            .attr(&quot;width&quot;, (d : any) &#x3D;&gt; d.bb.width+15)
            .attr(&quot;height&quot;, (d : any) &#x3D;&gt; d.bb.height+3)
            .attr(&quot;rx&quot;, 3)
            .attr(&quot;ry&quot;, 3);

    }

    y_flag(i, n_flags){
        return this.y(0)*(0.2+0.8*i/n_flags); // First at 30%, Last at ~80%
    }

    brushed(brush){
        console.log(&quot;brushed!&quot;, brush);
        if(d3.event.selection !&#x3D;&#x3D; null){
            const ext &#x3D; d3.event.selection.map(this.x.invert);
            this.filter(this.formatDayRequest(ext[0]), this.formatDayRequest(ext[1]));
        }
    }

    redraw(){

        console.log(&quot;redraw!&quot;);
        if (!this.g) {
            return;
        }

        this.redrawing &#x3D; true;

        const xt &#x3D; d3.event.transform.rescaleX(this.x);
        const scaledAxis &#x3D; this.xAxis.scale(xt);

        const domain &#x3D; xt.domain();
        this.nmonths &#x3D; d3.timeMonths(domain[0],domain[1]).length;

        const t &#x3D; d3.transition(&quot;redrawing&quot;).duration(500);

        this.g.select(&quot;.x.axis&quot;) // change the x axis
            .transition(t as any)
            .call(scaledAxis);

        this.g.selectAll(&quot;.bar&quot;)
            .transition(t as any)
            .attr(&quot;x&quot;, (d : any) &#x3D;&gt; xt(d.x0) + 1 )
            .attr(&quot;width&quot;, (d : any) &#x3D;&gt; xt(d.x1) - xt(d.x0) )
            .style(&quot;opacity&quot;, (d : any) &#x3D;&gt; (d.scale &#x3D;&#x3D;&#x3D; &quot;months&quot; &amp;&amp; this.nmonths &gt; 32) || (d.scale &#x3D;&#x3D;&#x3D; &quot;weeks&quot; &amp;&amp; this.nmonths &lt;&#x3D; 32) ? 1 : 0);

        //add_tooltips(bars);

        this.g.selectAll(&quot;.flag line&quot;)
            .transition(t as any)
            .attr(&quot;x1&quot;, (d : any) &#x3D;&gt; xt(d.date))
            .attr(&quot;x2&quot;, (d : any) &#x3D;&gt; xt(d.date));

        this.g.selectAll(&quot;.flag text&quot;)
            .transition(t as any)
            .attr(&quot;x&quot;, (d : any) &#x3D;&gt; xt(d.date)+10);

        this.g.selectAll(&quot;.flag rect&quot;)
            .transition(t as any)
            .attr(&quot;x&quot;, (d : any) &#x3D;&gt; xt(d.date));

        t.on(&quot;end&quot;, () &#x3D;&gt; this.redrawing &#x3D; false);

    }

    updateFlags(): number {
        if (!this.dates) {
            return 0;
        }

        let new_flags: any[] &#x3D; [];

        this.selectedFlags.forEach((flag) &#x3D;&gt; new_flags &#x3D; new_flags.concat(this.flag_idx[flag]));

        new_flags &#x3D; new_flags.sort(function(a,b){
            return b.count - a.count;
        });
        //console.log(new_flags);
        this.data_flags &#x3D; this.dates.slice(0,this.N_DATES).concat(
            new_flags.slice(this.event_page*this.N_EVENTS, (this.event_page+1)*this.N_EVENTS));

        this.draw_flags();

        return new_flags.length;
    }

    previousEvents(){
        this.event_page--;
        this.n_flags &#x3D; this.updateFlags();
    }

    nextEvents(){
        this.event_page++;
        this.n_flags &#x3D; this.updateFlags();
    }

    // called from template
    flagSelected(){
        this.event_page &#x3D; 0;
        this.n_flags &#x3D; this.updateFlags();
    }

    filter(start, end){
        console.log(&quot;filter!&quot;, start, end);
        this.searchService.addFieldSelect(this.datefield, {value: this.datefield+&quot;:[&quot;+start+&quot;..&quot;+end+&quot;]&quot;}, {valuesAreExpressions:true});
        this.searchService.search().then(
            results &#x3D;&gt; {
                if (!!this.view.selectView) {
                    this.resultsViewService.selectResultsViewName(this.view.selectView);
                }
            });
    }

    filter_cooc(date, display){
        console.log(&quot;filter event!&quot;,date, display);
        this.searchService.addFieldSelect(this.eventfield, {value: date, display: display});
        this.searchService.search().then(
            results &#x3D;&gt; {
                if (!!this.view.selectView) {
                    this.resultsViewService.selectResultsViewName(this.view.selectView);
                }
            });
    }

    filter_date(date, display){
        console.log(&quot;filter date!&quot;, this.datefield, date, display);
        this.searchService.addFieldSelect(this.datefield, {value: date, display: display});
        this.searchService.search().then(
            results &#x3D;&gt; {
                if (!!this.view.selectView) {
                    this.resultsViewService.selectResultsViewName(this.view.selectView);
                }
            });
    }

    ngOnChanges(changes: SimpleChanges) {
        if (!this.tooltip) {
            this.tooltip &#x3D; this.loadComponentService.loadComponent({component: BsTimelineTooltip});
            d3.select(this.tooltip.componentRef.location.nativeElement)
                .style(&quot;opacity&quot;, 0);
        }
        if (!!changes[&quot;results&quot;]) {
            if (changes[&quot;results&quot;].firstChange) {

            }
            this.getData();
        }
    }

    ngOnDestroy() {
        this.loadComponentService.unloadComponent(this.tooltip);
    }
}</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'DateItem.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
